name: update-rivals

on:
  issues:
    types: [opened, labeled]

concurrency:
  group: update-rivals-${{ github.repository }}
  cancel-in-progress: false

jobs:
  update:
    if: |
      contains(github.event.issue.body, '<!-- rivals-update -->') ||
      startsWith(github.event.issue.title, '[rivals]') ||
      (github.event.action == 'labeled' && github.event.label.name == 'update-rivals')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Parse issue and update rivals.json
        run: node src/parseRivals.js
        env:
          GITHUB_EVENT_PATH: ${{ github.event_path }}
          SELF_HANDLE: ${{ vars.SOLVEDAC_SELF_HANDLE }}

      - name: Commit rivals.json changes
        id: commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          if git diff --quiet -- rivals.json; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          git add rivals.json
          git commit -m "chore: update rivals from issue #${{ github.event.issue.number }}"
          branch="${GITHUB_REF_NAME:-main}"
          for i in 1 2 3; do
            if git push origin "HEAD:${branch}"; then
              echo "changed=true" >> "$GITHUB_OUTPUT"
              exit 0
            fi

            git pull --rebase origin "${branch}"
          done

          echo "Failed to push rivals.json after retries."
          exit 1

      - name: Comment issue with result summary
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const result = JSON.parse(fs.readFileSync('parse-result.json', 'utf8'));
            const body = [
              '라이벌 목록 업데이트 완료 ✅',
              '',
              `입력 형식: ${result.mode}`,
              `총 후보: ${result.stats.totalCandidates}`,
              `유효 핸들: ${result.stats.validated}`,
              `제거된 항목: ${result.stats.dropped}`
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });
